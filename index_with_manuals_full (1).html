<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸å‹•ç”£ç‰©ä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 1em;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab-button {
      padding: 10px 20px;
      background: #f1f1f1;
      border: none;
      cursor: pointer;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }
    .tab-button.active {
      background: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .search-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-form input, .search-form select {
      flex: 1;
      min-width: 150px;
    }
    .actions {
      margin-bottom: 20px;
    }
    .status-button {
      margin-right: 5px;
    }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background-color: #ffdddd;
      color: #f44336;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .success {
      background-color: #ddffdd;
      color: #4CAF50;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .pdf-preview {
      width: 100%;
      max-width: 300px;
      margin-top: 10px;
      display: block;
    }
    .pdf-link {
      display: inline-block;
      margin-top: 10px;
      color: #2196F3;
      text-decoration: none;
    }
    .pdf-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ä¸å‹•ç”£ç‰©ä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

<div style="text-align:right; margin: 20px 0;">
  <button onclick="window.open('æ“ä½œãƒãƒ‹ãƒ¥ã‚¢ãƒ«_HOTCIA.pdf')" style="margin-right: 10px;">ğŸ“˜ ã‚¯ãƒ«ãƒ¼ã•ã‚“æ“ä½œãƒãƒ‹ãƒ¥ã‚¢ãƒ«</button>
  <button onclick="window.open('ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹é †æ›¸_HOTCIA.pdf')">ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ¥­å‹™ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</button>
</div>

    
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
    </div>
    
    <div id="message" style="display: none;"></div>
    
    <div class="tabs">
      <button class="tab-button active" data-tab="register">ç‰©ä»¶ç™»éŒ²</button>
      <button class="tab-button" data-tab="list">ä¸€è¦§ãƒ»æ¤œç´¢</button>
      <button class="tab-button" data-tab="csv">CSVç®¡ç†</button>
      <button class="tab-button" data-tab="settings">è¨­å®š</button>
    </div>
    
    <!-- ç‰©ä»¶ç™»éŒ²ã‚¿ãƒ– -->
    <div id="register" class="tab-content active">
      <form id="propertyForm">
        <div class="form-group">
          <label>ç¨®åˆ¥</label>
          <select id="type">
            <option>åœŸåœ°</option>
            <option>ä¸­å¤æˆ¸å»º</option>
            <option>æ–°ç¯‰æˆ¸å»º</option>
          </select>
        </div>
        <div class="form-group">
          <label>ç‰©ä»¶å</label>
          <input type="text" id="name">
        </div>
        <div class="form-group">
          <label>è¡Œæ”¿åŒº</label>
          <select id="city">
            <option>æµå±±å¸‚</option>
            <option>æŸå¸‚</option>
            <option>æ¾æˆ¸å¸‚</option>
            <option>èˆ¹æ©‹å¸‚</option>
            <option>éŒãƒ¶è°·å¸‚</option>
          </select>
        </div>
        <div class="form-group">
          <label>ç•ªåœ°ä»¥ä¸‹</label>
          <input type="text" id="address">
        </div>
        <div class="form-group">
          <label>ä¾¡æ ¼</label>
          <input type="number" id="price">
        </div>
        <div class="form-group">
          <label>åœŸåœ°é¢ç©</label>
          <input type="number" id="landArea">
        </div>
        <div class="form-group">
          <label>å»ºç‰©é¢ç©</label>
          <input type="number" id="buildingArea">
        </div>
        <div class="form-group">
          <label>åª’ä½“</label>
          <select id="media">
            <option>ãƒ¬ã‚¤ãƒ³ã‚º</option>
            <option>at-home</option>
            <option>ã‚¹ãƒ¼ãƒ¢</option>
            <option>ä¸å‹•ç”£ã‚¸ãƒ£ãƒ‘ãƒ³</option>
          </select>
        </div>
        <div class="form-group">
          <label>æ¥­è€…å</label>
          <input type="text" id="agency">
        </div>
        <div class="form-group">
          <label>é›»è©±ç•ªå·</label>
          <input type="text" id="phone">
        </div>
        <div class="form-group">
          <label>è²©å£²çŠ¶æ³</label>
          <select id="status">
            <option>è²©å£²ä¸­</option>
            <option>æˆç´„</option>
            <option>å£²ã‚Šæ­¢ã‚</option>
          </select>
        </div>
        <div class="form-group">
          <label>PDFè³‡æ–™</label>
          <input type="file" id="pdfFile" accept=".pdf">
          <div id="pdfPreviewContainer"></div>
        </div>
        <button type="button" id="registerBtn">ç™»éŒ²</button>
      </form>
    </div>
    
    <!-- ä¸€è¦§ãƒ»æ¤œç´¢ã‚¿ãƒ– -->
    <div id="list" class="tab-content">
      <div class="search-form">
        <select id="searchType">
          <option value="">ç¨®åˆ¥ï¼ˆã™ã¹ã¦ï¼‰</option>
          <option>åœŸåœ°</option>
          <option>ä¸­å¤æˆ¸å»º</option>
          <option>æ–°ç¯‰æˆ¸å»º</option>
        </select>
        <select id="searchCity">
          <option value="">è¡Œæ”¿åŒºï¼ˆã™ã¹ã¦ï¼‰</option>
          <option>æµå±±å¸‚</option>
          <option>æŸå¸‚</option>
          <option>æ¾æˆ¸å¸‚</option>
          <option>èˆ¹æ©‹å¸‚</option>
          <option>éŒãƒ¶è°·å¸‚</option>
        </select>
        <input type="text" id="searchAddress" placeholder="ç•ªåœ°ä»¥ä¸‹">
        <input type="number" id="searchMinPrice" placeholder="ä¾¡æ ¼ä¸‹é™">
        <input type="number" id="searchMaxPrice" placeholder="ä¾¡æ ¼ä¸Šé™">
        <select id="searchStatus">
          <option value="">è²©å£²çŠ¶æ³ï¼ˆã™ã¹ã¦ï¼‰</option>
          <option>è²©å£²ä¸­</option>
          <option>æˆç´„</option>
          <option>å£²ã‚Šæ­¢ã‚</option>
        </select>
        <button id="searchBtn">æ¤œç´¢</button>
      </div>
      
      <div class="actions">
        <button class="status-button" data-status="è²©å£²ä¸­">è²©å£²ä¸­ã«å¤‰æ›´</button>
        <button class="status-button" data-status="æˆç´„">æˆç´„ã«å¤‰æ›´</button>
        <button class="status-button" data-status="å£²ã‚Šæ­¢ã‚">å£²ã‚Šæ­¢ã‚ã«å¤‰æ›´</button>
        <button id="deleteBtn">å‰Šé™¤</button>
        <button id="exportSelectedBtn">é¸æŠç‰©ä»¶ã‚’CSVå‡ºåŠ›</button>
      </div>
      
      <div id="resultCount"></div>
      
      <table id="propertyTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>ç¨®åˆ¥</th>
            <th>ç‰©ä»¶å</th>
            <th>è¡Œæ”¿åŒº</th>
            <th>ç•ªåœ°ä»¥ä¸‹</th>
            <th>ä¾¡æ ¼</th>
            <th>åœŸåœ°é¢ç©</th>
            <th>å»ºç‰©é¢ç©</th>
            <th>åª’ä½“</th>
            <th>æ¥­è€…å</th>
            <th>é›»è©±ç•ªå·</th>
            <th>è²©å£²çŠ¶æ³</th>
            <th>PDF</th>
            <th>ç™»éŒ²æ—¥</th>
            <th>æ›´æ–°æ—¥</th>
          </tr>
        </thead>
        <tbody>
          <!-- ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ï¼ˆæ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰ -->
        </tbody>
      </table>
    </div>
    
    <!-- CSVç®¡ç†ã‚¿ãƒ– -->
    <div id="csv" class="tab-content">
      <div class="form-group">
        <button id="exportAllBtn">å…¨ç‰©ä»¶CSVå‡ºåŠ›</button>
        <button id="exportOnSaleBtn">è²©å£²ä¸­ç‰©ä»¶CSVå‡ºåŠ›</button>
        <button id="exportSoldBtn">æˆç´„ç‰©ä»¶CSVå‡ºåŠ›</button>
        <button id="exportStoppedBtn">å£²ã‚Šæ­¢ã‚ç‰©ä»¶CSVå‡ºåŠ›</button>
      </div>
      <div class="form-group">
        <button id="downloadTemplateBtn">CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <div class="form-group">
        <label>CSVãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼</label>
        <input type="file" id="csvFile" accept=".csv">
        <button id="importCsvBtn">CSVå–è¾¼</button>
      </div>
    </div>
    
    <!-- è¨­å®šã‚¿ãƒ– -->
    <div id="settings" class="tab-content">
      <div class="form-group">
        <label>JSONBin.io APIã‚­ãƒ¼</label>
        <input type="text" id="apiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
      </div>
      <div class="form-group">
        <label>Bin ID (ç©ºæ¬„ã®å ´åˆã¯æ–°è¦ä½œæˆã•ã‚Œã¾ã™)</label>
        <input type="text" id="binId" placeholder="æ—¢å­˜ã®Bin IDãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„">
      </div>
      <div class="form-group">
        <button id="saveSettingsBtn">è¨­å®šã‚’ä¿å­˜</button>
        <button id="testConnectionBtn">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button id="createNewBinBtn">æ–°è¦Binä½œæˆ</button>
        <button id="syncDataBtn">ãƒ‡ãƒ¼ã‚¿åŒæœŸ</button>
      </div>
      <div id="connectionStatus"></div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let properties = [];
    let filteredProperties = [];  // æ˜ç¤ºçš„ã«é…åˆ—ã¨ã—ã¦åˆæœŸåŒ–
    let isDataModified = false;
    let searchExecuted = false;  // æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚ŒãŸã‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°
    
    // JSONBin.ioè¨­å®š
    const jsonBinConfig = {
      apiKey: localStorage.getItem('jsonBinApiKey') || '',
      binId: localStorage.getItem('jsonBinBinId') || '',
      baseUrl: 'https://api.jsonbin.io/v3/b'
    };
    
    // DOMè¦ç´ 
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const loading = document.getElementById('loading');
    const message = document.getElementById('message');
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function switchTab(tabId) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      tabButtons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
      
      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      tabContents.forEach(content => content.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      
      // è¨­å®šã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰è¨­å®šå€¤ã‚’èª­ã¿è¾¼ã‚€
      if (tabId === 'settings') {
        loadSettings();
      }
      
      // ä¸€è¦§ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ç‰©ä»¶ä¸€è¦§ã‚’æ›´æ–°
      if (tabId === 'list') {
        // ä¸€è¦§è¡¨ç¤ºæ™‚ã¯æ¤œç´¢å®Ÿè¡ŒçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        searchExecuted = false;
        loadProperties();
      }
    }
    
    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        switchTab(tabId);
      });
    });
    
    // æ¤œç´¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆã‚¿ãƒ–åˆ‡æ›¿ã¨ã¯åˆ¥ã«ï¼‰
    document.getElementById('searchBtn').addEventListener('click', function() {
      // æ¤œç´¢å®Ÿè¡Œãƒ•ãƒ©ã‚°ã‚’trueã«è¨­å®š
      searchExecuted = true;
      
      // æ¤œç´¢æ¡ä»¶ã‚’å–å¾—
      const type = document.getElementById('searchType').value;
      const city = document.getElementById('searchCity').value;
      const address = document.getElementById('searchAddress').value.toLowerCase();
      const minPrice = document.getElementById('searchMinPrice').value;
      const maxPrice = document.getElementById('searchMaxPrice').value;
      const status = document.getElementById('searchStatus').value;
      
      console.log('æ¤œç´¢æ¡ä»¶:', { type, city, address, minPrice, maxPrice, status });
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
      filteredProperties = properties.filter(property => {
        // å„æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
        const typeMatch = !type || property.type === type;
        const cityMatch = !city || property.city === city;
        const addressMatch = !address || (property.address && property.address.toLowerCase().includes(address));
        const minPriceMatch = !minPrice || (property.price && parseInt(property.price) >= parseInt(minPrice));
        const maxPriceMatch = !maxPrice || (property.price && parseInt(property.price) <= parseInt(maxPrice));
        const statusMatch = !status || property.status === status;
        
        // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
        console.log(`ç‰©ä»¶:ã€Œ${property.name}ã€, å ´æ‰€:${property.city}`);
        console.log(`  cityæ¡ä»¶:ã€Œ${city}ã€, ä¸€è‡´:${cityMatch}`);
        
        // ã™ã¹ã¦ã®æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿true
        const allMatch = typeMatch && cityMatch && addressMatch && minPriceMatch && maxPriceMatch && statusMatch;
        console.log(`  çµæœ:${allMatch ? 'ä¸€è‡´' : 'ä¸ä¸€è‡´'}`);
        return allMatch;
      });
      
      console.log(`æ¤œç´¢çµæœ: ${filteredProperties.length}ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
      
      // æ¤œç´¢çµæœã‚’è¡¨ç¤º
      renderPropertyTable();
    });
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
    function showLoading() {
      loading.style.display = 'flex';
    }
    
    function hideLoading() {
      loading.style.display = 'none';
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(text, isError = false) {
      message.textContent = text;
      message.className = isError ? 'error' : 'success';
      message.style.display = 'block';
      
      setTimeout(() => {
        message.style.display = 'none';
      }, 5000);
    }
    
    // PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    document.getElementById('pdfFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        document.getElementById('pdfPreviewContainer').innerHTML = '';
        return;
      }
      
      if (file.type !== 'application/pdf') {
        showMessage('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
        e.target.value = '';
        document.getElementById('pdfPreviewContainer').innerHTML = '';
        return;
      }
      
      // PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
      const previewHtml = `
        <div style="margin-top: 10px;">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWZpbGUtdHlwZS1wZGYiPjxwYXRoIGQ9Ik0xNCA4djUuNUExLjUgMS41IDAgMCAxIDEyLjUgMTVIMTVsNC00YzEtMS01LTE1LTUtMTVTMiA1IDIgMTZjLjUgMi41IDIgNCAxLjUgNyAxLjIgMS00IDMtNCAxaC0uMkEyIDIgMCAwIDEgMCAyMi4xYTIuMiAyLjIgMCAwIDEgMi03LjljLjQgMi43IDIuMSA5LjkgNS41IDMuOSAwIDAgMSAyIDUgMi41UzIyLjVgIi8+PHBhdGggZD0iTTEzLjUgMmMuMiAxLjYuOSA0LjIgMiAzIDEuMy0xLjMuNS0zLjQtMi0zeiIvPjxwYXRoIGQ9Ik0xMyAxNXYzYTEuOCAxLjggMCAwIDEtMiAyYy00IDAtNS4zLTcuMy0xLTEwLjUiLz48cGF0aCBkPSJNMTQgMTVoMmE3LjI0IDcuMjQgMCAwIDAgMy44LTEuMWwtLjgtM2MtLjQtMS44IDAtMi4zIDEtMy45Ii8+PC9zdmc+" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
          <span>${file.name}</span> (${(file.size / 1024).toFixed(2)} KB)
        </div>
      `;
      document.getElementById('pdfPreviewContainer').innerHTML = previewHtml;
    });
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // è¨­å®šã®èª­ã¿è¾¼ã¿
    function loadSettings() {
      document.getElementById('apiKey').value = jsonBinConfig.apiKey;
      document.getElementById('binId').value = jsonBinConfig.binId;
    }
    
    // è¨­å®šã®ä¿å­˜
    document.getElementById('saveSettingsBtn').onclick = function() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const binId = document.getElementById('binId').value.trim();
      
      jsonBinConfig.apiKey = apiKey;
      jsonBinConfig.binId = binId;
      
      localStorage.setItem('jsonBinApiKey', apiKey);
      localStorage.setItem('jsonBinBinId', binId);
      
      showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    };
    
    // æ¥ç¶šãƒ†ã‚¹ãƒˆ
    document.getElementById('testConnectionBtn').onclick = async function() {
      const statusElement = document.getElementById('connectionStatus');
      statusElement.textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
      statusElement.style.color = '#333';
      
      if (!jsonBinConfig.apiKey) {
        statusElement.textContent = 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
        statusElement.style.color = 'red';
        return;
      }
      
      if (!jsonBinConfig.binId) {
        statusElement.textContent = 'Bin IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã™ã‚‹ã‹ã€æ—¢å­˜ã®Bin IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        statusElement.style.color = 'orange';
        return;
      }
      
      try {
        showLoading();
        const response = await fetch(`${jsonBinConfig.baseUrl}/${jsonBinConfig.binId}`, {
          method: 'GET',
          headers: {
            'X-Master-Key': jsonBinConfig.apiKey
          }
        });
        
        if (response.ok) {
          statusElement.textContent = 'æ¥ç¶šæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã™';
          statusElement.style.color = 'green';
        } else {
          statusElement.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`;
          statusElement.style.color = 'red';
        }
      } catch (error) {
        statusElement.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
        statusElement.style.color = 'red';
      } finally {
        hideLoading();
      }
    };
    
    // æ–°è¦Binä½œæˆ
    document.getElementById('createNewBinBtn').onclick = async function() {
      const statusElement = document.getElementById('connectionStatus');
      
      if (!jsonBinConfig.apiKey) {
        statusElement.textContent = 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
        statusElement.style.color = 'red';
        return;
      }
      
      try {
        showLoading();
        const initialData = { properties: [] };
        
        const response = await fetch(`${jsonBinConfig.baseUrl}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': jsonBinConfig.apiKey,
            'X-Bin-Private': 'false'
          },
          body: JSON.stringify(initialData)
        });
        
        if (response.ok) {
          const data = await response.json();
          const newBinId = data.metadata.id;
          
          jsonBinConfig.binId = newBinId;
          document.getElementById('binId').value = newBinId;
          localStorage.setItem('jsonBinBinId', newBinId);
          
          statusElement.textContent = `æ–°è¦Binã‚’ä½œæˆã—ã¾ã—ãŸã€‚Bin ID: ${newBinId}`;
          statusElement.style.color = 'green';
          
          showMessage(`æ–°è¦Binã‚’ä½œæˆã—ã¾ã—ãŸã€‚ã“ã®IDã‚’ä»–ã®ç«¯æœ«ã§ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™ã€‚Bin ID: ${newBinId}`);
        } else {
          statusElement.textContent = `Binä½œæˆã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`;
          statusElement.style.color = 'red';
        }
      } catch (error) {
        statusElement.textContent = `Binä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
        statusElement.style.color = 'red';
      } finally {
        hideLoading();
      }
    };
    
    // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
    document.getElementById('syncDataBtn').onclick = async function() {
      if (isDataModified) {
        if (confirm('ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚JSONBin.ioã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
          await savePropertiesToJSONBin();
        }
      } else {
        if (confirm('JSONBin.ioã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
          await loadPropertiesFromJSONBin();
          showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
          renderPropertyTable();
        }
      }
    };
    
    // JSONBin.ioã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    async function loadPropertiesFromJSONBin() {
      if (!jsonBinConfig.apiKey || !jsonBinConfig.binId) {
        showMessage('APIã‚­ãƒ¼ã¨Bin IDã‚’è¨­å®šã—ã¦ãã ã•ã„', true);
        return null;
      }
      
      try {
        showLoading();
        const response = await fetch(`${jsonBinConfig.baseUrl}/${jsonBinConfig.binId}`, {
          method: 'GET',
          headers: {
            'X-Master-Key': jsonBinConfig.apiKey
          }
        });
        
        if (!response.ok) {
          throw new Error(`JSONBin.ioã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        properties = data.record.properties || [];
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
        localStorage.setItem('properties', JSON.stringify(properties));
        isDataModified = false;
        
        return properties;
      } catch (error) {
        showMessage(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
        console.error('JSONBin.ioèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      } finally {
        hideLoading();
      }
    }
    
    // JSONBin.ioã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    async function savePropertiesToJSONBin() {
      if (!jsonBinConfig.apiKey || !jsonBinConfig.binId) {
        showMessage('APIã‚­ãƒ¼ã¨Bin IDã‚’è¨­å®šã—ã¦ãã ã•ã„', true);
        return false;
      }
      
      try {
        showLoading();
        const dataToSave = { properties: properties };
        
        const response = await fetch(`${jsonBinConfig.baseUrl}/${jsonBinConfig.binId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': jsonBinConfig.apiKey
          },
          body: JSON.stringify(dataToSave)
        });
        
        if (!response.ok) {
          throw new Error(`JSONBin.ioã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} ${response.statusText}`);
        }
        
        isDataModified = false;
        return true;
      } catch (error) {
        showMessage(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
        console.error('JSONBin.ioä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        return false;
      } finally {
        hideLoading();
      }
    }
    
    // PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
    function getBase64FromFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
    
    // ç‰©ä»¶ç™»éŒ²
    document.getElementById('registerBtn').onclick = async function() {
      const type = document.getElementById('type').value;
      const name = document.getElementById('name').value;
      const city = document.getElementById('city').value;
      const address = document.getElementById('address').value;
      const price = document.getElementById('price').value;
      const landArea = document.getElementById('landArea').value;
      const buildingArea = document.getElementById('buildingArea').value;
      const media = document.getElementById('media').value;
      const agency = document.getElementById('agency').value;
      const phone = document.getElementById('phone').value;
      const status = document.getElementById('status').value;
      const pdfFile = document.getElementById('pdfFile').files[0];
      
      if (!name || !city) {
        showMessage('ç‰©ä»¶åã¨è¡Œæ”¿åŒºã¯å¿…é ˆã§ã™', true);
        return;
      }
      
      try {
        showLoading();
        
        // PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        let pdfData = null;
        if (pdfFile) {
          try {
            pdfData = await getBase64FromFile(pdfFile);
          } catch (error) {
            console.error('PDFãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
            hideLoading();
            return;
          }
        }
        
        // æ–°ã—ã„ç‰©ä»¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        const now = new Date().toISOString();
        const newProperty = {
          type,
          name,
          city,
          address,
          price,
          landArea,
          buildingArea,
          media,
          agency,
          phone,
          status,
          pdf: pdfData ? {
            name: pdfFile.name,
            size: pdfFile.size,
            type: pdfFile.type,
            data: pdfData
          } : null,
          createdAt: now,
          updatedAt: now
        };
        
        // ç‰©ä»¶ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«è¿½åŠ 
        properties.push(newProperty);
        localStorage.setItem('properties', JSON.stringify(properties));
        isDataModified = true;
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('propertyForm').reset();
        document.getElementById('pdfPreviewContainer').innerHTML = '';
        
        // JSONBin.ioã«ã‚‚ä¿å­˜ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        let jsonBinSaved = false;
        if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
          jsonBinSaved = await savePropertiesToJSONBin();
        }
        
        if (jsonBinSaved) {
          showMessage('ç‰©ä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜ï¼‰');
        }
      } catch (error) {
        console.error('ç‰©ä»¶ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ç‰©ä»¶ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
      } finally {
        hideLoading();
      }
    };
    
    // ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    function loadProperties() {
      // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
      const storedProperties = localStorage.getItem('properties');
      properties = storedProperties ? JSON.parse(storedProperties) : [];
      
      // JSONBin.ioãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€ãã“ã‹ã‚‰ã‚‚èª­ã¿è¾¼ã‚€
      if (jsonBinConfig.apiKey && jsonBinConfig.binId && properties.length === 0) {
        loadPropertiesFromJSONBin().then(data => {
          if (data) {
            renderPropertyTable();
          }
        });
      } else {
        renderPropertyTable();
      }
    }
    
    // ç‰©ä»¶ä¸€è¦§ã®è¡¨ç¤º
    function renderPropertyTable() {
      const tbody = document.querySelector('#propertyTable tbody');
      tbody.innerHTML = '';
      
      // è¡¨ç¤ºã™ã‚‹ç‰©ä»¶ãƒªã‚¹ãƒˆã‚’æ±ºå®š
      // æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‚’è¡¨ç¤ºï¼ˆãŸã¨ãˆ0ä»¶ã§ã‚‚ï¼‰
      // æ¤œç´¢å®Ÿè¡Œå‰ã¯å…¨ç‰©ä»¶ã‚’è¡¨ç¤º
      let displayProperties = searchExecuted ? filteredProperties : properties;
      
      // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
      console.log('æ¤œç´¢å®Ÿè¡Œæ¸ˆã¿:', searchExecuted);
      console.log('è¡¨ç¤ºç‰©ä»¶æ•°:', displayProperties.length);
      console.log('å…¨ç‰©ä»¶æ•°:', properties.length);
      console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œç‰©ä»¶æ•°:', filteredProperties.length);
      console.log('è¡¨ç¤ºå¯¾è±¡:', displayProperties);
      
      // çµæœä»¶æ•°ã‚’è¡¨ç¤º
      document.getElementById('resultCount').textContent = `${displayProperties.length}ä»¶ã®ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
      
      displayProperties.forEach((property, index) => {
        const row = document.createElement('tr');
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const checkboxCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.setAttribute('data-index', index);
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);
        
        // åŸºæœ¬æƒ…å ±
        [
          property.type, 
          property.name, 
          property.city, 
          property.address, 
          property.price, 
          property.landArea, 
          property.buildingArea, 
          property.media, 
          property.agency, 
          property.phone, 
          property.status
        ].forEach(value => {
          const cell = document.createElement('td');
          cell.textContent = value || '';
          row.appendChild(cell);
        });
        
        // PDFãƒªãƒ³ã‚¯
        const pdfCell = document.createElement('td');
        if (property.pdf && property.pdf.data) {
          const link = document.createElement('a');
          link.textContent = property.pdf.name;
          link.className = 'pdf-link';
          link.setAttribute('href', property.pdf.data);
          link.setAttribute('target', '_blank');
          link.setAttribute('download', property.pdf.name);
          pdfCell.appendChild(link);
        }
        row.appendChild(pdfCell);
        
        // ç™»éŒ²æ—¥ãƒ»æ›´æ–°æ—¥
        [formatDate(property.createdAt), formatDate(property.updatedAt)].forEach(value => {
          const cell = document.createElement('td');
          cell.textContent = value;
          row.appendChild(cell);
        });
        
        tbody.appendChild(row);
      });
    }
    
    // ç‰©ä»¶æ¤œç´¢ï¼ˆã“ã®é–¢æ•°ã¯å‰Šé™¤ã€ä¸Šéƒ¨ã§å†å®šç¾©æ¸ˆã¿ï¼‰
    
    // ã™ã¹ã¦é¸æŠ/è§£é™¤
    document.getElementById('selectAll').onclick = function() {
      const checkboxes = document.querySelectorAll('#propertyTable tbody input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    };
    
    // è²©å£²çŠ¶æ³å¤‰æ›´ãƒœã‚¿ãƒ³
    document.querySelectorAll('.status-button').forEach(button => {
      button.onclick = async function() {
        const newStatus = this.getAttribute('data-status');
        const checkboxes = document.querySelectorAll('#propertyTable tbody input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
          showMessage('ç‰©ä»¶ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
          return;
        }
        
        // é¸æŠã•ã‚ŒãŸç‰©ä»¶ã®çŠ¶æ…‹ã‚’å¤‰æ›´
        checkboxes.forEach(checkbox => {
          const index = parseInt(checkbox.getAttribute('data-index'));
          const collection = filteredProperties.length > 0 ? filteredProperties : properties;
          
          if (collection[index]) {
            collection[index].status = newStatus;
            collection[index].updatedAt = new Date().toISOString();
            
            // å…ƒã®propertiesã‚‚æ›´æ–°ï¼ˆfilteredPropertiesã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆï¼‰
            if (filteredProperties.length > 0) {
              const originalIndex = properties.findIndex(p => 
                p.name === collection[index].name && 
                p.city === collection[index].city && 
                p.address === collection[index].address
              );
              
              if (originalIndex !== -1) {
                properties[originalIndex].status = newStatus;
                properties[originalIndex].updatedAt = collection[index].updatedAt;
              }
            }
          }
        });
        
        // æ›´æ–°ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        localStorage.setItem('properties', JSON.stringify(properties));
        isDataModified = true;
        
        // JSONBin.ioã«ã‚‚ä¿å­˜ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        let jsonBinSaved = false;
        if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
          jsonBinSaved = await savePropertiesToJSONBin();
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
        renderPropertyTable();
        
        if (jsonBinSaved) {
          showMessage(`${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’ã€Œ${newStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸï¼ˆJSONBin.ioã«ã‚‚ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼‰`);
        } else if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
          showMessage(`${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’ã€Œ${newStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸãŒã€JSONBin.ioã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ`);
        } else {
          showMessage(`${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’ã€Œ${newStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜ï¼‰`);
        }
      };
    });
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    document.getElementById('deleteBtn').onclick = async function() {
      const checkboxes = document.querySelectorAll('#propertyTable tbody input[type="checkbox"]:checked');
      
      if (checkboxes.length === 0) {
        showMessage('ç‰©ä»¶ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
        return;
      }
      
      if (!confirm(`é¸æŠã—ãŸ${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸç‰©ä»¶ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åé›†ï¼ˆé™é †ã«ã‚½ãƒ¼ãƒˆï¼‰
      const indexes = Array.from(checkboxes).map(checkbox => 
        parseInt(checkbox.getAttribute('data-index'))
      ).sort((a, b) => b - a); // é™é †ã«ã‚½ãƒ¼ãƒˆ
      
      // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ã¦ç‰©ä»¶ã‚’å‰Šé™¤ï¼ˆå¤§ãã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰å‰Šé™¤ï¼‰
      if (filteredProperties.length > 0) {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‹ã‚‰å‰Šé™¤
        const propertiesToRemove = indexes.map(index => filteredProperties[index]);
        
        // ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚‚å‰Šé™¤
        propertiesToRemove.forEach(propertyToRemove => {
          const originalIndex = properties.findIndex(p => 
            p.name === propertyToRemove.name && 
            p.city === propertyToRemove.city && 
            p.address === propertyToRemove.address
          );
          
          if (originalIndex !== -1) {
            properties.splice(originalIndex, 1);
          }
        });
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‹ã‚‰ã‚‚å‰Šé™¤
        indexes.forEach(index => {
          filteredProperties.splice(index, 1);
        });
      } else {
        // é€šå¸¸ã®ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        indexes.forEach(index => {
          properties.splice(index, 1);
        });
      }
      
      // æ›´æ–°ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      localStorage.setItem('properties', JSON.stringify(properties));
      isDataModified = true;
      
      // JSONBin.ioã«ã‚‚ä¿å­˜ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
      let jsonBinSaved = false;
      if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
        jsonBinSaved = await savePropertiesToJSONBin();
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
      renderPropertyTable();
      
      if (jsonBinSaved) {
        showMessage(`${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆJSONBin.ioã«ã‚‚åæ˜ ã•ã‚Œã¾ã—ãŸï¼‰`);
      } else if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
        showMessage(`${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸãŒã€JSONBin.ioã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ`);
      } else {
        showMessage(`${checkboxes.length}ä»¶ã®ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿åæ˜ ï¼‰`);
      }
    };
    
    // é¸æŠç‰©ä»¶ã®CSVå‡ºåŠ›
    document.getElementById('exportSelectedBtn').onclick = function() {
      const checkboxes = document.querySelectorAll('#propertyTable tbody input[type="checkbox"]:checked');
      
      if (checkboxes.length === 0) {
        showMessage('ç‰©ä»¶ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸç‰©ä»¶ã‚’åé›†
      const selectedProperties = Array.from(checkboxes).map(checkbox => {
        const index = parseInt(checkbox.getAttribute('data-index'));
        return filteredProperties.length > 0 ? filteredProperties[index] : properties[index];
      });
      
      exportPropertiesToCSV(selectedProperties, 'é¸æŠç‰©ä»¶');
    };
    
    // å…¨ç‰©ä»¶CSVå‡ºåŠ›
    document.getElementById('exportAllBtn').onclick = function() {
      if (properties.length === 0) {
        showMessage('ç‰©ä»¶ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
        return;
      }
      
      exportPropertiesToCSV(properties, 'å…¨ç‰©ä»¶');
    };
    
    // è²©å£²ä¸­ç‰©ä»¶CSVå‡ºåŠ›
    document.getElementById('exportOnSaleBtn').onclick = function() {
      const onSaleProperties = properties.filter(property => property.status === 'è²©å£²ä¸­');
      
      if (onSaleProperties.length === 0) {
        showMessage('è²©å£²ä¸­ã®ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“', true);
        return;
      }
      
      exportPropertiesToCSV(onSaleProperties, 'è²©å£²ä¸­ç‰©ä»¶');
    };
    
    // æˆç´„ç‰©ä»¶CSVå‡ºåŠ›
    document.getElementById('exportSoldBtn').onclick = function() {
      const soldProperties = properties.filter(property => property.status === 'æˆç´„');
      
      if (soldProperties.length === 0) {
        showMessage('æˆç´„æ¸ˆã¿ã®ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“', true);
        return;
      }
      
      exportPropertiesToCSV(soldProperties, 'æˆç´„ç‰©ä»¶');
    };
    
    // å£²ã‚Šæ­¢ã‚ç‰©ä»¶CSVå‡ºåŠ›
    document.getElementById('exportStoppedBtn').onclick = function() {
      const stoppedProperties = properties.filter(property => property.status === 'å£²ã‚Šæ­¢ã‚');
      
      if (stoppedProperties.length === 0) {
        showMessage('å£²ã‚Šæ­¢ã‚ã®ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“', true);
        return;
      }
      
      exportPropertiesToCSV(stoppedProperties, 'å£²ã‚Šæ­¢ã‚ç‰©ä»¶');
    };
    
    // CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    document.getElementById('downloadTemplateBtn').onclick = function() {
      const headers = ['ç¨®åˆ¥', 'ç‰©ä»¶å', 'è¡Œæ”¿åŒº', 'ç•ªåœ°ä»¥ä¸‹', 'ä¾¡æ ¼', 'åœŸåœ°é¢ç©', 'å»ºç‰©é¢ç©', 'åª’ä½“', 'æ¥­è€…å', 'é›»è©±ç•ªå·', 'è²©å£²çŠ¶æ³'];
      const example = ['åœŸåœ°', 'ã‚µãƒ³ãƒ—ãƒ«ä½å®…åœ°', 'æµå±±å¸‚', 'ä¸­å¤®1-2-3', '3000', '120', '90', 'ãƒ¬ã‚¤ãƒ³ã‚º', 'ã‚µãƒ³ãƒ—ãƒ«ä¸å‹•ç”£', '0120-000-000', 'è²©å£²ä¸­'];
      
      const csvContent = [
        headers.join(','),
        example.join(',')
      ].join('\n');
      
      downloadCSV(csvContent, 'csv_template');
    };
    
    // CSVå–è¾¼ãƒœã‚¿ãƒ³
    document.getElementById('importCsvBtn').onclick = async function() {
      const fileInput = document.getElementById('csvFile');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          showLoading();
          const csvContent = e.target.result;
          const lines = csvContent.split('\n');
          
          if (lines.length < 2) {
            showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', true);
            hideLoading();
            return;
          }
          
          const headers = lines[0].split(',');
          const headerMap = {
            'ç¨®åˆ¥': 'type',
            'ç‰©ä»¶å': 'name',
            'è¡Œæ”¿åŒº': 'city',
            'ç•ªåœ°ä»¥ä¸‹': 'address',
            'ä¾¡æ ¼': 'price',
            'åœŸåœ°é¢ç©': 'landArea',
            'å»ºç‰©é¢ç©': 'buildingArea',
            'åª’ä½“': 'media',
            'æ¥­è€…å': 'agency',
            'é›»è©±ç•ªå·': 'phone',
            'è²©å£²çŠ¶æ³': 'status'
          };
          
          const newProperties = [];
          const now = new Date().toISOString();
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const values = line.split(',');
            const property = {};
            
            headers.forEach((header, index) => {
              const key = headerMap[header.trim()] || header.trim();
              property[key] = values[index] ? values[index].trim() : '';
            });
            
            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            if (!property.name || !property.city) continue;
            
            property.createdAt = now;
            property.updatedAt = now;
            
            newProperties.push(property);
          }
          
          if (newProperties.length === 0) {
            showMessage('å–ã‚Šè¾¼ã¿å¯èƒ½ãªç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
            hideLoading();
            return;
          }
          
          // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¨çµåˆ
          properties = properties.concat(newProperties);
          localStorage.setItem('properties', JSON.stringify(properties));
          isDataModified = true;
          
          // JSONBin.ioã«ã‚‚ä¿å­˜ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
          let jsonBinSaved = false;
          if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
            jsonBinSaved = await savePropertiesToJSONBin();
          }
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
          fileInput.value = '';
          
          if (jsonBinSaved) {
            showMessage(`${newProperties.length}ä»¶ã®ç‰©ä»¶ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆJSONBin.ioã«ã‚‚ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼‰`);
          } else if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
            showMessage(`${newProperties.length}ä»¶ã®ç‰©ä»¶ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸãŒã€JSONBin.ioã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ`);
          } else {
            showMessage(`${newProperties.length}ä»¶ã®ç‰©ä»¶ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜ï¼‰`);
          }
          
          // ä¸€è¦§è¡¨ç¤ºãŒé–‹ã„ã¦ã„ã‚Œã°æ›´æ–°
          if (document.getElementById('list').classList.contains('active')) {
            renderPropertyTable();
          }
        } catch (error) {
          showMessage(`CSVå–è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
          console.error('CSVå–è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        } finally {
          hideLoading();
        }
      };
      
      reader.readAsText(file);
    };
    
    // CSVå‡ºåŠ›
    function exportPropertiesToCSV(propertiesList, filePrefix) {
      const headers = ['ç¨®åˆ¥', 'ç‰©ä»¶å', 'è¡Œæ”¿åŒº', 'ç•ªåœ°ä»¥ä¸‹', 'ä¾¡æ ¼', 'åœŸåœ°é¢ç©', 'å»ºç‰©é¢ç©', 'åª’ä½“', 'æ¥­è€…å', 'é›»è©±ç•ªå·', 'è²©å£²çŠ¶æ³', 'ç™»éŒ²æ—¥', 'æ›´æ–°æ—¥'];
      
      const rows = [
        headers.join(',')
      ];
      
      propertiesList.forEach(property => {
        const row = [
          property.type || '',
          property.name || '',
          property.city || '',
          property.address || '',
          property.price || '',
          property.landArea || '',
          property.buildingArea || '',
          property.media || '',
          property.agency || '',
          property.phone || '',
          property.status || '',
          formatDate(property.createdAt),
          formatDate(property.updatedAt)
        ].map(value => {
          // ã‚«ãƒ³ãƒã‚„æ”¹è¡Œã‚’å«ã‚€å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
          if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
            return `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        });
        
        rows.push(row.join(','));
      });
      
      const csvContent = rows.join('\n');
      downloadCSV(csvContent, filePrefix);
      
      showMessage(`${propertiesList.length}ä»¶ã®ç‰©ä»¶ã‚’CSVå‡ºåŠ›ã—ã¾ã—ãŸ`);
    }
    
    // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadCSV(csvContent, filePrefix) {
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const now = new Date();
      const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
      const link = document.createElement('a');
      
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `${filePrefix}_${dateStr}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã®è¨­å®šï¼ˆç·¨é›†ãŒå¤šç™ºã—ã¦ã‚‚JSONBin.ioã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ããªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    let autoSaveTimeout = null;
    
    function scheduleAutoSave() {
      // ã™ã§ã«ã‚¿ã‚¤ãƒãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ä¸€æ—¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      
      // 5ç§’å¾Œã«ä¿å­˜ã‚’å®Ÿè¡Œï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
      autoSaveTimeout = setTimeout(async () => {
        if (isDataModified && jsonBinConfig.apiKey && jsonBinConfig.binId) {
          try {
            // ä¿å­˜ã‚’å®Ÿè¡Œ
            await savePropertiesToJSONBin();
            console.log('è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ');
            isDataModified = false;
          } catch (error) {
            console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          }
        }
      }, 5000);
    }
    
    // åˆæœŸåŒ–å‡¦ç†
    loadSettings();
    loadProperties();
    
    // JSONBin.ioã®è¨­å®šãŒå­˜åœ¨ã—ã¦ã„ã‚Œã°ã€èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œï¼‰
    if (jsonBinConfig.apiKey && jsonBinConfig.binId) {
      setTimeout(async () => {
        try {
          await loadPropertiesFromJSONBin();
          console.log('JSONBin.ioã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
          renderPropertyTable();
        } catch (error) {
          console.error('åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
      }, 1000);
    }
  </script>
  <!-- HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®çµ‚ã‚ã‚Š -->
</body>
</html>